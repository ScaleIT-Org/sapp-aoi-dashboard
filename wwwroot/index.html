<!DOCTYPE html>
<html>
  <head>	
	<title>SICK AOI Data Systems</title>
	
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />	
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- App Icon Apple iOS -->
<link rel="apple-touch-icon" href="images/touch-icon-iphone.png">
<link rel="apple-touch-icon" sizes="76x76" href="images/touch-icon-ipad.png">
<link rel="apple-touch-icon" sizes="120x120" href="images/touch-icon-iphone-retina.png">
<link rel="apple-touch-icon" sizes="152x152" href="images/touch-icon-ipad-retina.png">
<!-- Startup image -->
<link rel="apple-touch-startup-image" href="images/ScaleIT-Logo.jpg">
<!-- Hide Safari User Interface Components -->
<meta name="apple-mobile-web-app-capable" content="yes">

<script src="/js/jquery.min.js" type="text/javascript"></script>

<script src="/js/highcharts.js" type="text/javascript"></script>
<script src="/js/highcharts.data.js" type="text/javascript"></script>
<script src="/js/highcarts.exporting.js" type="text/javascript"></script>
<script src="/js/highcarts.boost.js" type="text/javascript"></script>

<script src="/js/bootstrap.min.js" type="text/javascript"></script>
<script src="/js/bootstrap-select.min.js" type="text/javascript"></script>

<script src="/js/eventsource.js" type="text/javascript"></script>
<script src="/js/task.js" type="text/javascript"></script>

<link rel="stylesheet" href="/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/bootstrap-select.min.css">

<script>//Globale Variablen
	var ajaxUrl = "http://localhost:3000/Get";
	var jsonObject = {};
	var init = true;
</script>
<script>	//Server Sent Events
      var es = new EventSource("http://localhost:3000/sse");
      es.addEventListener("open",  function(event){
	  }, false);
	  
      es.addEventListener("message", function(event){
		jsonObject = JSON.parse(event.data);
		($('#chart').highcharts() !== undefined) ? updateChartData() : null;
	  }, false);
	  
      es.addEventListener("error",  function(event){
	  }, false);
</script>

<script> //Crawl and show Json Metadata
	$(document).ready(function () {
		doAjax();
		var str = "";
		$(window).bind('load', function(){
			for (i in jsonObject){

				if (i != "BoardsUnderTest") {
				str += i + ""+" : "+ jsonObject[i]+""+"<br>";
				}
			}
		 	document.getElementById("meta").innerHTML = str;
		 });
	});

</script>

<!-- Get Data from DotNet Server -->
<script type="text/javascript" src="api/data/last"></script>

<script> //Register I/O Handlers
	$(document).ready(function () {
		document.getElementById("SaveConfig").onclick = function () { 
		ajaxUrl = $("#ajaxconfig").val(); 
		doAjax();
		};
	});
</script>
<script>
var mySeries = [];
$(window).bind('load', function(){
    var chart = $('#chart').highcharts({
		exporting: {
			buttons: {
				customButton: {
					text: 'Randomize ',
					onclick: function () {
						for (i in this.series) {
							var randomized = [];
							data = this.series[i].data;
							for (j in data) {
								if (data[i].name != "Reference") {
									xrand = Math.floor(Math.random() * (10-(-10)))+(-10)
									yrand = Math.floor(Math.random() * (10-(-10)))+(-10)
									randomized.push({x: data[j].x+xrand, y: data[j].y+yrand, text: data[j].text}); 	
								}
							}
							this.series[i].setData(randomized);
						}
					}
				},
			}
		},
        chart: {
            type: 'scatter',
            zoomType: 'xy',
            events : {
            	load : function() {
						var seriesNr = 1;
						var chart = $('#chart').highcharts();
						for (b in jsonObject.BoardsUnderTest) {
							// Add options to Bootstrap-Select 
							$("#Boards").append($('<option>', {value: b,text: b}));
							$('.selectpicker').selectpicker('refresh');
							
							var seriesData = [];
							chart.addSeries({ 
								id: b,
								name: 'BoardsUnderTest '+b,
								showInLegend: true, 
								visible: true,
								data: []
							});
							
							var series = this.series[seriesNr];
							seriesNr++;
												
							var Board = jsonObject.BoardsUnderTest[b].ComponentsUnderTest;
							for (i in Board)
							{	
								if (i.startsWith('C')) {
									//COMPONENT
									var x = null, y = null, label = "";
									for (j in Board[i].TestFeature)
									{
										if(x === null) {
											x = parseInt(Board[i].TestFeature[j].Value);
										} else {
											y = parseInt(Board[i].TestFeature[j].Value);
										}
										label = i;
									}
								seriesData.push({x: x, y: y, text: label});
								}
								if(i.startsWith('IC') ){
									//INTEGRATED CIRCUIT

									var x = null, y = null, label = "";
									for (j in Board[i].TestFeature)
									{
										var done = false;
										if(x === null) {
											x = parseInt(Board[i].TestFeature[j].Value);
										} else {
											y = parseInt(Board[i].TestFeature[j].Value);
											done = true;
										}
										label = i;
										if(done === true) {
											seriesData.push({x: x, y: y, text: label});
											x = null;
											y = null;
											done = false;
										}
									}
									series.setData(seriesData);
									mySeries.push(seriesData);
								} 
							}
						}
					dropdownIntelligence();
                }
            }
        },
        loading: {
            labelStyle: {
                backgroundImage: 'url("https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif")',
                display: 'block',
                width: '100%',
                height: '291%',
                backgroundColor: '#000'
            }
        },
		colors: ['#0000FF', '#fc9c3a', '#11a200', '#95c200' ],
        title: {
            text: 'SICK AOI Data X, Y Shift'
        },
        subtitle: {
            text: 'Auftrag 6'
        },
        xAxis: {
            title: {
                enabled: true,
                text: 'X-Axis'
            },
            minRange:285,
            min:-100,
        	//max:150,
            //center Axsis
            plotBands: [{
                from: 25,
                to: 100,
                color: '#AED581',
                borderColor: 'red',
                label:{text:'Toleranz X',  verticalAlign: 'bottom'}
            },
            {
                from: 125,
                to: 160,
                color: '#e57373',
                borderColor: 'red',
                label:{text:'Kritisch X',  verticalAlign: 'bottom'}
            }],
            plotLines: [{
			    color: 'black', // Color value
			    dashStyle: 'Solid', // Style of the plot line. Default to solid
			    value: 0, // Value of where the line will appear
			    width: 2 // Width of the line    
			  },
              {
                color: 'red', // Color value
                dashStyle: 'longdash', // Style of the plot line. Default to solid
                value: 180, // Value of where the line will appear
                //should be 180 according to spec
                width: 2, // Width of the line   
                label:{text:'Toleranz X'}
              }],
            startOnTick: true,
            endOnTick: true,
            showLastLabel: true
        },
        yAxis: {
            title: {
                text: 'Y-Axis'
            },
            // minRange:185,
            //min:0,
        	//max:150,
            //center Axsis
            plotLines: [{
			    color: 'black', // Color value
			    dashStyle: 'Solid', // Style of the plot line. Default to solid
			    value: 0, // Value of where the line will appear
			    width: 2 // Width of the line    
			  },
              {
                color: 'red', // Color value
                dashStyle: 'longdash', // Style of the plot line. Default to solid
                value: 140, // Value of where the line will appear
                //should be 140 according to spec
                width: 2, // Width of the line  
                label:{text:'Toleranz Y'} 
              }],
        },
        legend: {
            layout: 'vertical',
            align: 'left',
            verticalAlign: 'top',
            x: 100,
            y: 70,
            floating: true,
            backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF',
            borderWidth: 1
        },
        plotOptions: {
            scatter: {
                marker: {
                    radius: 5,
                    states: {
                        hover: {
                            enabled: true,
                            lineColor: 'rgb(100,100,100)'
                        }
                    }
                },
                states: {
                    hover: {
                        marker: {
                            enabled: false
                        }
                    }
                },
                tooltip: {
                    headerFormat: '<b>{series.name} </b><br>',
                    pointFormat: '<b>{point.text}</b> <br> {point.x} x, {point.y} y'
                }
            }
        },
        series: [{
			name: 'Reference',  
			showInLegend: false, 
            color: 'rgba(100, 100, 100, .5)',
            data: [[0, 0]]
        }]
    });
});
</script>

<script> // Dropdown intelligence
function dropdownIntelligence() {
	if (init === true) {
		//Default configuration
        $('#Boards').selectpicker('deselectAll');
        $('#Boards').selectpicker('val', '3827582');
		// $('#Boards').selectpicker('selectAll');
        $('#Boards').selectpicker('val', 'Integrated Circuits');
		// $('#Components').selectpicker('selectAll');
		init = false;
	}
	
	var chart = $('#chart').highcharts();
	$('.selectpicker').selectpicker();
	//Board Selection
    $('#Boards').on('change', function(){
    	chart.showLoading();
		//Hide all series 
		$(chart.series).each(function(){
			this.update({ showInLegend: false, visible: false});
		});

		//Show selected series
		var selected = $(this).val();
		selected.forEach(function(i) {
			var series = chart.get(i);
			series.update({ showInLegend: true, visible: true});
		});
		chart.redraw();
		chart.hideLoading();
	});
	// IC/C Selection
	$('#Components').off().on('change', function(){
		//chart.showLoading();
		//Show selected series
		var selected = $(this).val();
		var mySeriesIndex = 0;
		$(chart.series).each(function(){
			var newData = [];
			if(this.name !== "Reference"){
				this.update({data: mySeries[mySeriesIndex]})
				mySeriesIndex++;
				this.data.forEach(function(i) {
					if(selected !== null && i.text.startsWith(selected[0])){
						newData.push({x: i.x, y: i.y, text: i.text});
					}
				});
			}
			(selected !== null && selected.length < 2)? this.update({data: newData}) : null;
			//In this case newData is empty
			(selected == null)? this.update({data: newData}) : null;
		});
		chart.redraw();
		chart.hideLoading();
	});
};
</script>
<script> //Helper Funktions
function doAjax() {
		 $.ajax({
			dataType: 'jsonp',
			data: "data=yeah",                      
			jsonp: 'callback',
			url: ajaxUrl,                     
			success: function(data) {
				jsonObject = data;
			}
		});
	}

function updateChartData() {
	  // Check for Web worker support!
	if (typeof(Worker) !== "undefined") {
		// Check if Web worker already exists!
    	if (typeof(w) == "undefined") {
			w = new Worker("./js/task.js");
			
	
			mySeries = []
			var chart = $('#chart').highcharts();
			//Update Dropdown Menue
				for (b in jsonObject.BoardsUnderTest) {
					if (chart !== undefined && !chart.get(b)) {
						//Create new Series
						$("#Boards").append($('<option>', {value: b,text: b}));
						$("#Boards").selectpicker('val', ($("#Boards").selectpicker('val') == null)? [b] : $("#Boards").selectpicker('val').concat([b]));
						$('.selectpicker').selectpicker('refresh');

						chart.addSeries({ 
							id: b,
							name: 'BoardsUnderTest '+b,
							showInLegend: true, 
							visible: true,
							data: []
						});
					}
				}
			//Start Web Worker Crawling Data
			w.postMessage(jsonObject); // Send data to our worker.		
		} else {
			console.log("worker busy")
		}
	} else {
		alert("Your Browser does not Support Web Workers")
	}

	w.addEventListener('message', function(e) {
		var answer = e.data
		for (b in answer) {
			var series = chart.get(b);
			var selected = $('#Components').val();
		}
		
		(selected !== null && selected.length == 2)? series.setData(answer[b][0]) : null;
		(selected !== null && selected.length == 1 && selected[0] == "C")? series.setData(answer[b][1]) : null ;
		(selected !== null && selected.length == 1 && selected[0] == "IC")? series.setData(answer[b][2]) :  null;
		(selected == null)? series.setData([]) : null;
		
		mySeries.push(answer[b][0]);
		
		stopWorker();
	}, false);	
			
	function stopWorker() { 
		w.terminate();
		w = undefined;
	}
dropdownIntelligence();
}
</script>
</head>
	<body onload="">
	
		<!-- Tab definitions -->
		<ul class="nav nav-pills nav-justified">
		  <li class="active"><a data-toggle="tab" href="#visualization">Visualization</a></li>
		  <li><a data-toggle="tab" href="#config">Configuration</a></li>
		</ul>
		
		<div class="tab-content">
			<div id="visualization" class="tab-pane fade in active">	
				<fieldset id="core-dashboard">
					<legend>SICK AOI Data System</legend>
					<div class="form-group">
						<select class="selectpicker" data-width="auto" id="Boards" multiple data-live-search="true" title="BoardsUnderTest">
						</select>

						<select class="selectpicker" data-width="fit" id="Components" multiple data-live-search="true" title="ComponentsUnderTest">
						  <optgroup id="C" label="Components">
						  <option value="C"> Components</option>
						  </optgroup>
						  <optgroup id="IC" label="Integrated Circuits">
						  <option value="IC"> Integrated Circuits</option>
						  </optgroup>
						</select>
					</div>
					<ul id="chart"></ul>
				</fieldset>
				<fieldset>
					<legend>MetaData</legend>
					<ul id="meta"></ul>
				</fieldset>
			</div>
			<div id="config" class="tab-pane fade">
				<!--Configuration -->
				<h1>Configuration</h1>
				V 0.0.1 SICK AOI Data Visualizer <br><br>

				<div class="form-group">
				  <label for="sseconfig">SSE Endpoint:</label>
				  <input type="text" class="form-control" id="sseconfig">
				</div>
				<div class="form-group">
				  <label for="ajaxconfig">AJAX Endpoint:</label>
				  <input type="text" class="form-control" id="ajaxconfig" value="http://localhost:3000/Get" >
				</div>
				<button id="SaveConfig" type="button" class="btn btn-default"><b>Speichern</b></button>
			</div>
		</div>
	</body>	
    <script type="text/javascript">
        var frameable = true;
        if(frameable){
            $('fieldset:not(#core-dashboard)').hide();
            $('.nav').hide();
        }
    </script>
</html>
